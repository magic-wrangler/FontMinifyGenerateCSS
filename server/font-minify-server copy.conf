server {
  listen 8080;
  server_name localhost;
  # 指定 DNS 解析器
  # resolver 8.8.8.8 8.8.4.4;
  access_log /var/log/nginx/bofeng.fun.access.log;
  error_log /var/log/nginx/bofeng.fun.error.log;

  location ~.*\.(js|css|html|png|jpg|PDF)$ {
    root /usr/share/nginx/html/h5/;
    index index.html index.htm;
  }

  # 静态图片资源
  location /images/ {
    alias /usr/share/nginx/html/assest/;
  }

  # 无极转发 解决跨域问题
  location /wuji/api/ {
    # 精简正则表达式
    rewrite ^/wuji/api/(.*) /api/$1 break;

    # 代理设置
    proxy_pass https://wujicode.cn;
    # 得设置成代理的域名
    proxy_set_header Host 'wujicode.cn';
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # HTTPS 相关配置
    proxy_ssl_server_name on;
    proxy_ssl_protocols TLSv1.2 TLSv1.3;
    proxy_ssl_ciphers 'TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384';

    # 错误处理
    proxy_intercept_errors on;

    # 日志记录
    access_log /var/log/nginx/wuji_access.log;
    error_log /var/log/nginx/wuji_error.log;

    # CORS 配置
    if ($request_method = 'OPTIONS') {
      add_header 'Access-Control-Allow-Origin' '*';
      add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
      add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization';
      add_header 'Access-Control-Max-Age' 1728000;
      add_header 'Content-Type' 'text/plain charset=UTF-8';
      add_header 'Content-Length' 0;
      return 204;
    }

    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization' always;
    add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;

    # 性能优化
    proxy_buffering on;
    proxy_buffers 16 32k;
    proxy_busy_buffers_size 64k;
    proxy_temp_file_write_size 64k;
  }

  # 默认指向地址 → 静态文件
  location / {
    # add_header Access-Control-Allow-Origin 'https://*.bofeng.fun' always;
    # add_header Access-Control-Allow-Origin 'http://*.bofeng.fun' always;
    add_header Access-Control-Allow-Origin '*' always;
    add_header Access-Control-Allow-Headers '*';
    add_header Access-Control-Allow-Methods '*';
    add_header Access-Control-Allow-Credentials 'true';
    alias /usr/share/nginx/html/other/;
    try_files $uri /$uri/ /other/index.html;
    # root /usr/share/nginx/html/other/;
  }
  location = /other/index.html {
    # add_header Access-Control-Allow-Origin 'https://*.bofeng.fun' always;
    # add_header Access-Control-Allow-Origin 'http://*.bofeng.fun' always;
    add_header Access-Control-Allow-Origin '*' always;
    add_header Access-Control-Allow-Headers '*';
    add_header Access-Control-Allow-Methods '*';
    add_header Access-Control-Allow-Credentials 'true';
    alias /usr/share/nginx/html/other/index.html;
  }
  # tools
  location /tools {
    # add_header Access-Control-Allow-Origin 'https://*.bofeng.fun' always;
    # add_header Access-Control-Allow-Origin 'http://*.bofeng.fun' always;
    add_header Access-Control-Allow-Origin '*' always;
    add_header Access-Control-Allow-Headers '*';
    add_header Access-Control-Allow-Methods '*';
    add_header Access-Control-Allow-Credentials 'true';
    alias /usr/share/nginx/html/other/;
    try_files $uri /$uri/ /other/tools.html;
    # root /usr/share/nginx/html/other/;
  }
  location = /other/tools.html {
    # add_header Access-Control-Allow-Origin 'https://*.bofeng.fun' always;
    # add_header Access-Control-Allow-Origin 'http://*.bofeng.fun' always;
    add_header Access-Control-Allow-Origin '*' always;
    add_header Access-Control-Allow-Headers '*';
    add_header Access-Control-Allow-Methods '*';
    add_header Access-Control-Allow-Credentials 'true';
    alias /usr/share/nginx/html/other/tools.html;
  }
  # h5
  location /h5 {
    # add_header Access-Control-Allow-Origin 'https://*.bofeng.fun' always;
    # add_header Access-Control-Allow-Origin 'http://*.bofeng.fun' always;
    add_header Access-Control-Allow-Origin '*' always;
    add_header Access-Control-Allow-Headers '*';
    add_header Access-Control-Allow-Methods '*';
    add_header Access-Control-Allow-Credentials 'true';
    alias /usr/share/nginx/html/h5/;
    try_files $uri /$uri/ /h5/index.html;
    # root /usr/share/nginx/html/other/;
  }
  location = /h5/index.html {
    # add_header Access-Control-Allow-Origin 'https://*.bofeng.fun' always;
    # add_header Access-Control-Allow-Origin 'http://*.bofeng.fun' always;
    add_header Access-Control-Allow-Origin '*' always;
    add_header Access-Control-Allow-Headers '*';
    add_header Access-Control-Allow-Methods '*';
    add_header Access-Control-Allow-Credentials 'true';
    alias /usr/share/nginx/html/h5/index.html;
  }
  # 转发到 集成服务
  location ~ ^/([^/]+)/cgi-bin/(.*) {
    proxy_pass http://127.0.0.1:21160/$1/$2?$query_string;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Port $server_port;
    proxy_pass_header TCOA_TICKET;
    proxy_pass_request_headers on;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_connect_timeout 15s;
    proxy_read_timeout 60s;
    proxy_send_timeout 20s;
  }
  # # 静态文件
  # location ~ ^/([^/]+)/(.*) {
  #   # alias：默认携带域名路由参数：bofeng.fun/aaa → /usr/share/nginx/html/aaa 、 root 不会携带
  #   root /usr/share/nginx/html;
  #   try_files $uri $uri/ /$1/index.html;
  #   add_header Cache-Control max-age=0;
  # }
  # 掩码库
  location /mss {
    proxy_pass http://124.222.160.56:3000/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $remote_addr;
  }
  location ~ /static/.*\.(gif|jpg|jpeg|png|bmp|swf|flv|mp4|ico)$ {
    expires 30d;
    access_log off;
    proxy_pass http://124.222.160.56:3000; # 这个地方是重点 静态资源的访问
  }
  location ~ /static/.*\.(js|css)$ {
    expires 30d;
    access_log off;
    proxy_pass http://124.222.160.56:3000; # 这个地方是重点 静态资源的访问
  }
  # 路由配置信息   解决路由跳转失败
  location @router {
    rewrite ^.*$ /index.html last;
  }

  # 字体上传API
  location ~ ^/([^/]+)/api/(.*) {
    # CORS预检请求处理
    if ($request_method = 'OPTIONS') {
      add_header 'Access-Control-Allow-Origin' '*';
      add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
      add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';
      add_header 'Access-Control-Max-Age' 1728000;
      add_header 'Content-Type' 'text/plain; charset=utf-8';
      add_header 'Content-Length' 0;
      return 204;
    }
    
    # CORS
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;

    # 代理到后端
    proxy_pass http://124.222.160.56:7199/$1/$2?$query_string;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # 隐藏上游的 CORS 头
    proxy_hide_header Access-Control-Allow-Origin;
    
    client_max_body_size 20M;
    client_body_buffer_size 128k;
    
    proxy_connect_timeout 30s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
  }
}
